<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tr·∫£ ph√≤ng - Qu·∫£n l√Ω nh√† tr·ªç</title>
  <style>
    /* Gi·ªØ nguy√™n ph·∫ßn CSS nh∆∞ c≈© */
    * {margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;}
    body {background-color:#f5f5f5;color:#333;line-height:1.6;font-size:14px;}
    /* ... (gi·ªØ nguy√™n to√†n b·ªô CSS) ... */
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
<!-- Gi·ªØ nguy√™n ph·∫ßn HTML nh∆∞ c≈© -->
<header>
  <h1>Qu·∫£n l√Ω nh√† tr·ªç - Tr·∫£ ph√≤ng</h1>
  <div>
    <button onclick="window.location.href='dashboard.html'" class="btn back-btn">Quay l·∫°i</button>
    <button id="logoutBtn" class="btn logout-btn">ƒêƒÉng xu·∫•t</button>
  </div>
</header>

<div class="container">
  <h2>Th√¥ng tin tr·∫£ ph√≤ng</h2>
  <div class="form-container">
    <div class="form-group">
      <label for="roomSelect">Ch·ªçn ph√≤ng</label>
      <select id="roomSelect"><option value="">-- Ch·ªçn ph√≤ng --</option></select>
    </div>

    <div id="bookingInfo" style="display:none;">
      <!-- Gi·ªØ nguy√™n ph·∫ßn HTML nh∆∞ c≈© -->
    </div>
  </div>
</div>

<div class="notification" id="notification">N·ªôi dung ƒë√£ ƒë∆∞·ª£c sao ch√©p!</div>

<script>
const firebaseConfig={apiKey:"AIzaSyAz38ll5L6nZOicZyQRFtKd0TuzohrLFws",authDomain:"quan-ly-nha-tro-2a4bf.firebaseapp.com",databaseURL:"https://quan-ly-nha-tro-2a4bf-default-rtdb.asia-southeast1.firebasedatabase.app",projectId:"quan-ly-nha-tro-2a4bf",storageBucket:"quan-ly-nha-tro-2a4bf.firebasestorage.app",messagingSenderId:"490747665921",appId:"1:490747665921:web:48b0e2bad3a0f894c22a00"};
firebase.initializeApp(firebaseConfig);const auth=firebase.auth();const database=firebase.database();

let currentUser = null;
let currentBooking=null;let currentTotalCost=0;let bankConfig={};
let priceConfig = {}; // L∆∞u tr·ªØ c·∫•u h√¨nh gi√°

auth.onAuthStateChanged(user=>{
  if(!user){
    window.location.href='index.html';
  }else{
    currentUser = user;
    loadPriceConfig();
    loadBankConfig();
    loadOccupiedRooms();
    loadLicenseStatus();
  }
});

// H√†m load c·∫•u h√¨nh gi√° - ƒê√É C·∫¢I THI·ªÜN
function loadPriceConfig(){
  database.ref(`users/${currentUser.uid}/config/prices`).once('value').then(snapshot=>{
    if(snapshot.exists()){
      priceConfig = snapshot.val();
      
      // ƒê·∫∑t gi√° tr·ªã m·∫∑c ƒë·ªãnh n·∫øu kh√¥ng c√≥ trong database
      document.getElementById('electricityPrice').value = priceConfig.electricity || 3500;
      document.getElementById('waterPrice').value = priceConfig.water || 20000;
      document.getElementById('wifiCost').value = priceConfig.wifi || 50000;
      document.getElementById('garbageCost').value = priceConfig.garbage || 20000;
      
      console.log('ƒê√£ load c·∫•u h√¨nh gi√°:', priceConfig);
    } else {
      // N·∫øu kh√¥ng c√≥ c·∫•u h√¨nh, s·ª≠ d·ª•ng gi√° m·∫∑c ƒë·ªãnh
      priceConfig = {
        electricity: 3500,
        water: 20000,
        wifi: 50000,
        garbage: 20000
      };
      
      document.getElementById('electricityPrice').value = priceConfig.electricity;
      document.getElementById('waterPrice').value = priceConfig.water;
      document.getElementById('wifiCost').value = priceConfig.wifi;
      document.getElementById('garbageCost').value = priceConfig.garbage;
      
      console.log('S·ª≠ d·ª•ng gi√° m·∫∑c ƒë·ªãnh:', priceConfig);
    }
    
    // T√≠nh to√°n l·∫°i chi ph√≠ n·∫øu c√≥ booking hi·ªán t·∫°i
    if(currentBooking){
      calculateCost();
    }
  }).catch(error => {
    console.error('L·ªói khi load c·∫•u h√¨nh gi√°:', error);
    // S·ª≠ d·ª•ng gi√° m·∫∑c ƒë·ªãnh n·∫øu c√≥ l·ªói
    document.getElementById('electricityPrice').value = 3500;
    document.getElementById('waterPrice').value = 20000;
    document.getElementById('wifiCost').value = 50000;
    document.getElementById('garbageCost').value = 20000;
  });
}

function loadBankConfig(){
  database.ref(`users/${currentUser.uid}/config/bank`).once('value').then(snapshot=>{
    if(snapshot.exists()){
      bankConfig = snapshot.val();
      console.log('ƒê√£ load c·∫•u h√¨nh ng√¢n h√†ng:', bankConfig);
    } else {
      console.log('Ch∆∞a c√≥ c·∫•u h√¨nh ng√¢n h√†ng');
    }
  }).catch(error => {
    console.error('L·ªói khi load c·∫•u h√¨nh ng√¢n h√†ng:', error);
  });
}

function loadOccupiedRooms(){
  database.ref(`users/${currentUser.uid}/rooms`).once('value').then(snapshot=>{
    const select = document.getElementById('roomSelect');
    select.innerHTML = '<option value="">-- Ch·ªçn ph√≤ng --</option>';
    
    console.log('D·ªØ li·ªáu ph√≤ng:', snapshot.val());
    
    if(snapshot.exists()){
      let hasOccupiedRooms = false;
      
      snapshot.forEach(roomSnapshot=>{
        const room = roomSnapshot.val();
        const roomNumber = roomSnapshot.key;
        
        console.log('Ki·ªÉm tra ph√≤ng:', roomNumber, room);
        
        if(room.status === 'occupied'){
          hasOccupiedRooms = true;
          const option = document.createElement('option');
          option.value = roomNumber;
          option.textContent = `Ph√≤ng ${roomNumber}`;
          select.appendChild(option);
        }
      });
      
      if(!hasOccupiedRooms){
        const option = document.createElement('option');
        option.textContent = 'Kh√¥ng c√≥ ph√≤ng ƒë√£ thu√™';
        option.disabled = true;
        select.appendChild(option);
      }
    } else {
      const option = document.createElement('option');
      option.textContent = 'Kh√¥ng c√≥ ph√≤ng ƒë√£ thu√™';
      option.disabled = true;
      select.appendChild(option);
    }
  }).catch(error => {
    console.error('L·ªói khi load ph√≤ng:', error);
  });
}

// C√°c h√†m c√≤n l·∫°i gi·ªØ nguy√™n v·ªõi m·ªôt s·ªë c·∫£i ti·∫øn nh·ªè
document.getElementById('roomSelect').addEventListener('change',function(){
  const roomId = this.value;
  if(!roomId){
    document.getElementById('bookingInfo').style.display = 'none';
    currentBooking = null;
    return;
  }
  
  database.ref(`users/${currentUser.uid}/bookings`).orderByChild('roomId').equalTo(roomId).once('value').then(snapshot=>{
    if(snapshot.exists()){
      snapshot.forEach(bookingSnapshot=>{
        currentBooking = {
          id: bookingSnapshot.key,
          ...bookingSnapshot.val()
        };
        
        document.getElementById('customerName').value = currentBooking.customerName;
        document.getElementById('idNumber').value = currentBooking.idNumber;
        document.getElementById('initialElectricity').value = currentBooking.initialElectricity;
        document.getElementById('initialWater').value = currentBooking.initialWater;
        document.getElementById('bookingInfo').style.display = 'block';
        
        // T√≠nh to√°n chi ph√≠ ngay khi load th√¥ng tin ph√≤ng
        calculateCost();
      });
    } else {
      alert('Kh√¥ng t√¨m th·∫•y th√¥ng tin ƒë·∫∑t ph√≤ng cho ph√≤ng n√†y');
      document.getElementById('bookingInfo').style.display = 'none';
    }
  }).catch(error => {
    console.error('L·ªói khi load th√¥ng tin ƒë·∫∑t ph√≤ng:', error);
    alert('C√≥ l·ªói x·∫£y ra khi t·∫£i th√¥ng tin ƒë·∫∑t ph√≤ng');
  });
});

function calculateCost(){
  if(!currentBooking) return;
  
  const finalElectricity = parseInt(document.getElementById('finalElectricity').value) || 0;
  const finalWater = parseInt(document.getElementById('finalWater').value) || 0;
  const electricityPrice = parseInt(document.getElementById('electricityPrice').value) || 0;
  const waterPrice = parseInt(document.getElementById('waterPrice').value) || 0;
  const wifiCost = parseInt(document.getElementById('wifiCost').value) || 0;
  const garbageCost = parseInt(document.getElementById('garbageCost').value) || 0;
  const otherCost = parseInt(document.getElementById('otherCost').value) || 0;
  
  // Validate ch·ªâ s·ªë
  if(finalElectricity < currentBooking.initialElectricity){
    document.getElementById('electricityCost').textContent = 'Ch·ªâ s·ªë kh√¥ng h·ª£p l·ªá';
    return;
  }
  
  if(finalWater < currentBooking.initialWater){
    document.getElementById('waterCost').textContent = 'Ch·ªâ s·ªë kh√¥ng h·ª£p l·ªá';
    return;
  }
  
  const electricityUsed = finalElectricity - currentBooking.initialElectricity;
  const waterUsed = finalWater - currentBooking.initialWater;
  const electricityCost = electricityUsed * electricityPrice;
  const waterCost = waterUsed * waterPrice;
  const roomCost = currentBooking.roomPrice;
  
  currentTotalCost = electricityCost + waterCost + roomCost + wifiCost + garbageCost + otherCost;
  
  document.getElementById('electricityCost').textContent = electricityCost.toLocaleString('vi-VN');
  document.getElementById('waterCost').textContent = waterCost.toLocaleString('vi-VN');
  document.getElementById('roomCost').textContent = roomCost.toLocaleString('vi-VN');
  document.getElementById('wifiCostDisplay').textContent = wifiCost.toLocaleString('vi-VN');
  document.getElementById('garbageCostDisplay').textContent = garbageCost.toLocaleString('vi-VN');
  document.getElementById('otherCostDisplay').textContent = otherCost.toLocaleString('vi-VN');
  document.getElementById('totalCost').textContent = currentTotalCost.toLocaleString('vi-VN');
}

// C√°c s·ª± ki·ªán input ƒë·ªÉ t√≠nh to√°n t·ª± ƒë·ªông
['finalElectricity','finalWater','electricityPrice','waterPrice','wifiCost','garbageCost','otherCost'].forEach(id=>{
  document.getElementById(id).addEventListener('input', calculateCost);
});

// C√°c h√†m c√≤n l·∫°i gi·ªØ nguy√™n
document.getElementById('generateQRBtn').addEventListener('click',function(){
  if(currentTotalCost <= 0){
    alert('Vui l√≤ng nh·∫≠p th√¥ng tin ƒë·ªÉ t√≠nh to√°n tr∆∞·ªõc khi t·∫°o m√£ QR');
    return;
  }
  if(!bankConfig.bankName || !bankConfig.bankAccount){
    alert('Ch∆∞a c·∫•u h√¨nh ng√¢n h√†ng trong C√†i ƒë·∫∑t');
    return;
  }
  
  const qrSection = document.getElementById('qrSection');
  const qrCodeDiv = document.getElementById('qrCode');
  qrCodeDiv.innerHTML = '';
  
  const today = new Date();
  const ngay = `${today.getDate()}/${today.getMonth()+1}/${today.getFullYear()}`;
  const content = `${bankConfig.bankContent || 'Thanh to√°n ti·ªÅn th√°ng'} ${ngay}`;
  
  const qrUrl = `https://img.vietqr.io/image/${bankConfig.bankName}-${bankConfig.bankAccount}-compact2.png?amount=${currentTotalCost}&addInfo=${encodeURIComponent(content)}`;
  
  const img = document.createElement('img');
  img.src = qrUrl;
  img.style.maxWidth = '200px';
  qrCodeDiv.appendChild(img);
  qrSection.style.display = 'block';
});

document.getElementById('copyZaloBtn').addEventListener('click', function(){
  if(currentTotalCost <= 0){
    alert('Vui l√≤ng t√≠nh to√°n tr∆∞·ªõc khi chia s·∫ª');
    return;
  }
  if(!bankConfig.bankName || !bankConfig.bankAccount){
    alert('Ch∆∞a c·∫•u h√¨nh ng√¢n h√†ng trong C√†i ƒë·∫∑t');
    return;
  }

  const today = new Date();
  const thang = today.getMonth() + 1;
  const nam = today.getFullYear();
  const ngay = `${today.getDate()}/${thang}/${nam}`;
  
  const content = `${bankConfig.bankContent || 'Thanh to√°n ti·ªÅn th√°ng'} ${thang}/${nam}`;
  const qrUrl = `https://img.vietqr.io/image/${bankConfig.bankName}-${bankConfig.bankAccount}-compact2.png?amount=${currentTotalCost}&addInfo=${encodeURIComponent(content)}`;

  const msg =
`üí≥ *THANH TO√ÅN TI·ªÄN PH√íNG TH√ÅNG ${thang}/${nam}*

üè† Ph√≤ng: ${currentBooking.roomId}
üë§ Kh√°ch h√†ng: ${currentBooking.customerName}
üìÖ Ng√†y t√≠nh: ${ngay}

üìä *CHI TI·∫æT THANH TO√ÅN:*
‚Ä¢ Ti·ªÅn ƒëi·ªán: ${document.getElementById('electricityCost').textContent} VNƒê
‚Ä¢ Ti·ªÅn n∆∞·ªõc: ${document.getElementById('waterCost').textContent} VNƒê  
‚Ä¢ Ti·ªÅn ph√≤ng: ${document.getElementById('roomCost').textContent} VNƒê
‚Ä¢ Ti·ªÅn WiFi: ${document.getElementById('wifiCostDisplay').textContent} VNƒê
‚Ä¢ Ti·ªÅn r√°c: ${document.getElementById('garbageCostDisplay').textContent} VNƒê
‚Ä¢ Ti·ªÅn kh√°c: ${document.getElementById('otherCostDisplay').textContent} VNƒê
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
üí∞ *T·ªîNG C·ªòNG: ${document.getElementById('totalCost').textContent} VNƒê*

üè¶ *TH√îNG TIN CHUY·ªÇN KHO·∫¢N:*
‚Ä¢ Ng√¢n h√†ng: ${bankConfig.bankName}
‚Ä¢ Ch·ªß TK: ${bankConfig.accountName || '---'}
‚Ä¢ S·ªë TK: ${bankConfig.bankAccount}
‚Ä¢ N·ªôi dung: ${content}

üì± *H∆Ø·ªöNG D·∫™N THANH TO√ÅN:*
1. Chuy·ªÉn kho·∫£n theo th√¥ng tin tr√™n
2. Ho·∫∑c qu√©t m√£ QR b√™n d∆∞·ªõi
3. G·ª≠i bi√™n lai cho ch·ªß tr·ªç sau khi thanh to√°n

üîó *M√É QR THANH TO√ÅN:*
${qrUrl}

_C·∫£m ∆°n b·∫°n!_`;

  navigator.clipboard.writeText(msg).then(() => {
    showNotification('ƒê√£ sao ch√©p n·ªôi dung thanh to√°n! D√°n v√†o Zalo ƒë·ªÉ g·ª≠i cho kh√°ch h√†ng.');
  }).catch(err => {
    console.error('L·ªói sao ch√©p: ', err);
    showNotification('L·ªói sao ch√©p!', true);
  });
});

document.getElementById('openZaloBtn').addEventListener('click',function(){
  const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  if(isMobile){
    window.location.href = 'zalo://';
    setTimeout(() => { window.location.href = 'https://zalo.me'; }, 1000);
  } else {
    window.open('https://zalo.me', '_blank');
  }
});

function showNotification(msg, isError = false){
  const noti = document.getElementById('notification');
  noti.textContent = msg;
  if(isError){
    noti.classList.add('error');
  } else {
    noti.classList.remove('error');
  }
  noti.classList.add('show');
  setTimeout(() => {
    noti.classList.remove('show');
  }, 3000);
}

document.getElementById('checkoutBtn').addEventListener('click', () => {
  if(!currentBooking) return;
  
  const finalElectricity = parseInt(document.getElementById('finalElectricity').value) || 0;
  const finalWater = parseInt(document.getElementById('finalWater').value) || 0;
  
  if(finalElectricity < currentBooking.initialElectricity){
    alert('Ch·ªâ s·ªë ƒëi·ªán kh√¥ng h·ª£p l·ªá');
    return;
  }
  if(finalWater < currentBooking.initialWater){
    alert('Ch·ªâ s·ªë n∆∞·ªõc kh√¥ng h·ª£p l·ªá');
    return;
  }
  
  const electricityUsed = finalElectricity - currentBooking.initialElectricity;
  const waterUsed = finalWater - currentBooking.initialWater;
  const electricityPrice = parseInt(document.getElementById('electricityPrice').value) || 0;
  const waterPrice = parseInt(document.getElementById('waterPrice').value) || 0;
  const wifiCost = parseInt(document.getElementById('wifiCost').value) || 0;
  const garbageCost = parseInt(document.getElementById('garbageCost').value) || 0;
  const otherCost = parseInt(document.getElementById('otherCost').value) || 0;
  const otherDescription = document.getElementById('otherDescription').value;
  const roomCost = currentBooking.roomPrice;
  
  const totalCost = electricityUsed * electricityPrice + waterUsed * waterPrice + roomCost + wifiCost + garbageCost + otherCost;
  
  const checkoutData = {
    roomId: currentBooking.roomId,
    bookingId: currentBooking.id,
    customerName: currentBooking.customerName,
    finalElectricity,
    finalWater,
    electricityUsed,
    waterUsed,
    electricityPrice,
    waterPrice,
    electricityCost: electricityUsed * electricityPrice,
    waterCost: waterUsed * waterPrice,
    roomCost,
    wifiCost,
    garbageCost,
    otherCost,
    otherDescription,
    totalCost,
    checkoutDate: new Date().toISOString(),
    notes: document.getElementById('checkoutNotes').value
  };
  
  database.ref(`users/${currentUser.uid}/checkouts`).push(checkoutData)
    .then(() => database.ref(`users/${currentUser.uid}/rooms/${currentBooking.roomId}`).update({status: 'available'}))
    .then(() => database.ref(`users/${currentUser.uid}/bookings/${currentBooking.id}`).remove())
    .then(() => {
      alert('Tr·∫£ ph√≤ng th√†nh c√¥ng!');
      window.location.reload();
    })
    .catch(error => {
      console.error('Error during checkout:', error);
      alert('C√≥ l·ªói x·∫£y ra khi tr·∫£ ph√≤ng');
    });
});

document.getElementById('logoutBtn').addEventListener('click', () => {
  auth.signOut().then(() => {
    window.location.href = 'index.html';
  });
});

function loadLicenseStatus(){
  database.ref(`users/${currentUser.uid}/license`).on('value', snapshot => {
    if(snapshot.exists() && snapshot.val().licensed){
      document.getElementById('licenseStatus').textContent = 'ƒê√£ c·∫•p b·∫£n quy·ªÅn';
    } else {
      document.getElementById('licenseStatus').textContent = 'Mi·ªÖn ph√≠';
    }
  });
}
</script>

<footer style="text-align:center; padding:10px; font-size:0.9rem;">
  ¬© <span id="copyrightYear"></span> Qu·∫£n l√Ω nh√† tr·ªç ‚Äî B·∫£n quy·ªÅn <strong id="licenseStatus">Mi·ªÖn ph√≠</strong>
  <div style="font-size:0.75rem; margin-top:4px; color:#666;">
    N·∫øu ƒë√£ k√≠ch ho·∫°t b·∫£n quy·ªÅn, h·ªá th·ªëng s·∫Ω l∆∞u kh√¥ng gi·ªõi h·∫°n s·ªë ph√≤ng.
  </div>
</footer>
<script>
  document.getElementById('copyrightYear').textContent = new Date().getFullYear();
</script>

</body>
</html>

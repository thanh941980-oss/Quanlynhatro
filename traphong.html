<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tr·∫£ ph√≤ng - Qu·∫£n l√Ω nh√† tr·ªç</title>
  <style>
    * {margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;}
    body {background-color:#f5f5f5;color:#333;line-height:1.6;font-size:14px;}
    header {background-color:#2c3e50;color:white;padding:1rem;display:flex;justify-content:space-between;align-items:center;}
    .container {max-width:1000px;margin:0 auto;padding:20px;}
    .form-container {background:white;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,0.1);padding:20px;margin-top:20px;}
    .form-group {margin-bottom:0.7rem;}
    .form-group label {display:block;margin-bottom:0.3rem;font-weight:500;}
    .form-group input,.form-group select,.form-group textarea{width:100%;padding:0.5rem;border:1px solid #ddd;border-radius:4px;font-size:0.9rem;}
    .form-row{display:flex;gap:15px;margin-bottom:0.7rem;}
    .form-row .form-group{flex:1;}
    .calculation-result{background:#f8f9fa;border-left:4px solid #3498db;padding:15px;margin:20px 0;border-radius:4px;}
    .btn{display:inline-block;padding:0.6rem 1.2rem;background:#3498db;color:white;border:none;border-radius:4px;font-size:0.9rem;cursor:pointer;transition:.3s;}
    .btn:hover{background:#2980b9;}
    .back-btn{background:#7f8c8d}.back-btn:hover{background:#95a5a6}
    .logout-btn{background:#e74c3c}.logout-btn:hover{background:#c0392b}
    .qr-section{margin-top:20px;text-align:center;display:none;padding:15px;background:#f1f8ff;border-radius:8px;}
    #qrCode{margin:15px auto;max-width:200px;}
    .action-buttons{display:flex;gap:10px;margin-top:15px;justify-content:center;flex-wrap:wrap;}
    .zalo-btn{background:#0068ff;display:flex;align-items:center;justify-content:center;gap:8px;}
    .zalo-btn:hover{background:#0051cc;}
    .qr-btn{background:#27ae60}.qr-btn:hover{background:#219653}
    .copy-btn{background:#9b59b6}.copy-btn:hover{background:#8e44ad}
    .zalo-icon{width:20px;height:20px;}
    .notification{position:fixed;top:20px;right:20px;padding:15px 20px;background:#2ecc71;color:white;border-radius:4px;box-shadow:0 4px 12px rgba(0,0,0,0.1);transform:translateX(100%);transition:transform .3s ease-out;z-index:1000;}
    .notification.show{transform:translateX(0);}
    .notification.error{background:#e74c3c;}
    .zalo-guide{margin-top:15px;padding:10px;background:#f9f9f9;border-radius:5px;border-left:4px solid #0068ff;font-size:.9rem;}
    @media(max-width:768px){header{flex-direction:column;align-items:flex-start;gap:10px}.form-row{flex-direction:column;gap:10px}.btn{width:100%;text-align:center;margin-top:10px}.container{padding:10px}h2{font-size:1.2rem;text-align:center}.action-buttons{flex-direction:column}}
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
<header>
  <h1>Qu·∫£n l√Ω nh√† tr·ªç - Tr·∫£ ph√≤ng</h1>
  <div>
    <button onclick="window.location.href='dashboard.html'" class="btn back-btn">Quay l·∫°i</button>
    <button id="logoutBtn" class="btn logout-btn">ƒêƒÉng xu·∫•t</button>
  </div>
</header>

<div class="container">
  <h2>Th√¥ng tin tr·∫£ ph√≤ng</h2>
  <div class="form-container">
    <div class="form-group">
      <label for="roomSelect">Ch·ªçn ph√≤ng</label>
      <select id="roomSelect"><option value="">-- Ch·ªçn ph√≤ng --</option></select>
    </div>

    <div id="bookingInfo" style="display:none;">
      <h3>Th√¥ng tin ƒë·∫∑t ph√≤ng</h3>
      <div class="form-row">
        <div class="form-group"><label>Ng∆∞·ªùi ƒë·∫∑t ph√≤ng</label><input type="text" id="customerName" readonly></div>
        <div class="form-group"><label>S·ªë CCCD/CMND</label><input type="text" id="idNumber" readonly></div>
      </div>

      <div class="form-row">
        <div class="form-group"><label>Ch·ªâ s·ªë ƒëi·ªán l√∫c ƒë·∫∑t</label><input type="number" id="initialElectricity" readonly></div>
        <div class="form-group"><label>Ch·ªâ s·ªë n∆∞·ªõc l√∫c ƒë·∫∑t</label><input type="number" id="initialWater" readonly></div>
      </div>

      <h3>Th√¥ng tin tr·∫£ ph√≤ng</h3>
      <div class="form-row">
        <div class="form-group"><label for="finalElectricity">Ch·ªâ s·ªë ƒëi·ªán l√∫c tr·∫£</label><input type="number" id="finalElectricity"></div>
        <div class="form-group"><label for="finalWater">Ch·ªâ s·ªë n∆∞·ªõc l√∫c tr·∫£</label><input type="number" id="finalWater"></div>
      </div>

      <div class="form-row">
        <div class="form-group"><label for="electricityPrice">ƒê∆°n gi√° ƒëi·ªán</label><input type="number" id="electricityPrice" value="3500"></div>
        <div class="form-group"><label for="waterPrice">ƒê∆°n gi√° n∆∞·ªõc</label><input type="number" id="waterPrice" value="20000"></div>
      </div>

      <div class="form-row">
        <div class="form-group"><label for="wifiCost">Ti·ªÅn WiFi</label><input type="number" id="wifiCost" value="50000"></div>
        <div class="form-group"><label for="garbageCost">Ti·ªÅn r√°c</label><input type="number" id="garbageCost" value="20000"></div>
      </div>

      <div class="form-row">
        <div class="form-group"><label for="otherCost">Ti·ªÅn kh√°c</label><input type="number" id="otherCost" value="0"></div>
        <div class="form-group"><label for="otherDescription">M√¥ t·∫£ kho·∫£n kh√°c</label><input type="text" id="otherDescription" placeholder="M√¥ t·∫£ kho·∫£n ph√≠ kh√°c"></div>
      </div>

      <div class="calculation-result">
        <h4>K·∫øt qu·∫£ t√≠nh to√°n</h4>
        <p>Ti·ªÅn ƒëi·ªán: <span id="electricityCost">0</span> VNƒê</p>
        <p>Ti·ªÅn n∆∞·ªõc: <span id="waterCost">0</span> VNƒê</p>
        <p>Ti·ªÅn ph√≤ng: <span id="roomCost">0</span> VNƒê</p>
        <p>Ti·ªÅn WiFi: <span id="wifiCostDisplay">0</span> VNƒê</p>
        <p>Ti·ªÅn r√°c: <span id="garbageCostDisplay">0</span> VNƒê</p>
        <p>Ti·ªÅn kh√°c: <span id="otherCostDisplay">0</span> VNƒê</p>
        <p><strong>T·ªïng c·ªông: <span id="totalCost">0</span> VNƒê</strong></p>

        <div class="action-buttons">
          <button id="generateQRBtn" class="btn qr-btn">T·∫°o m√£ QR thanh to√°n</button>
          <button id="copyZaloBtn" class="btn copy-btn">Sao ch√©p n·ªôi dung Zalo</button>
          <button id="openZaloBtn" class="btn zalo-btn">
            <svg class="zalo-icon" viewBox="0 0 24 24" fill="white">
              <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.894 17.477c-.194.175-.59.33-1.092.33-.6 0-1.047-.194-1.685-.65l-.6-.45-2.25 2.25c-.15.15-.45.15-.6 0l-1.875-1.875c-.15-.15-.15-.45 0-.6l2.25-2.25-.45-.6c-.45-.637-.6-1.092-.6-1.685 0-.502.155-.898.33-1.092.45-.45 1.335-.33 2.482.33 1.335.75 2.25 1.5 2.7 2.25.45.75.6 1.44.33 2.01-.15.45-.6.898-1.2 1.092zm.33-5.394c-.33 0-.637-.045-.93-.15-1.44-.6-3.75-1.2-6.75-1.2-3 0-5.31.6-6.75 1.2-.285.12-.6.165-.93.165-.6 0-1.2-.33-1.2-.93 0-.6.6-1.2 1.2-1.2.33 0 .63.045.93.15 1.44.6 3.75 1.2 6.75 1.2 3 0 5.31-.6 6.75-1.2.285-.12.6-.165.93-.165.6 0 1.2.33 1.2.93 0 .6-.6 1.2-1.2 1.2z"/>
            </svg>
            M·ªü Zalo
          </button>
        </div>

        <div class="zalo-guide">
          <p><strong>H∆∞·ªõng d·∫´n:</strong> Sao ch√©p n·ªôi dung thanh to√°n, sau ƒë√≥ m·ªü Zalo v√† d√°n v√†o tin nh·∫Øn ƒë·ªÉ g·ª≠i cho kh√°ch h√†ng.</p>
        </div>

        <div class="qr-section" id="qrSection">
          <h4>M√£ QR thanh to√°n</h4>
          <div id="qrCode"></div>
          <p>Qu√©t m√£ QR ƒë·ªÉ thanh to√°n</p>
        </div>
      </div>

      <div class="form-group"><label for="checkoutNotes">Ghi ch√∫</label><textarea id="checkoutNotes" rows="3"></textarea></div>
      <button id="checkoutBtn" class="btn">X√°c nh·∫≠n tr·∫£ ph√≤ng</button>
    </div>
  </div>
</div>

<div class="notification" id="notification">N·ªôi dung ƒë√£ ƒë∆∞·ª£c sao ch√©p!</div>

<script>
const firebaseConfig={apiKey:"AIzaSyAz38ll5L6nZOicZyQRFtKd0TuzohrLFws",authDomain:"quan-ly-nha-tro-2a4bf.firebaseapp.com",databaseURL:"https://quan-ly-nha-tro-2a4bf-default-rtdb.asia-southeast1.firebasedatabase.app",projectId:"quan-ly-nha-tro-2a4bf",storageBucket:"quan-ly-nha-tro-2a4bf.firebasestorage.app",messagingSenderId:"490747665921",appId:"1:490747665921:web:48b0e2bad3a0f894c22a00"};
firebase.initializeApp(firebaseConfig);const auth=firebase.auth();const database=firebase.database();

let currentBooking=null;let currentTotalCost=0;let bankConfig={};

auth.onAuthStateChanged(user=>{if(!user){window.location.href='index.html';}else{loadPriceConfig();loadBankConfig();loadOccupiedRooms();}});

function loadPriceConfig(){database.ref('config/prices').once('value').then(s=>{if(s.exists()){const c=s.val();document.getElementById('electricityPrice').value=c.electricity||3500;document.getElementById('waterPrice').value=c.water||20000;document.getElementById('wifiCost').value=c.wifi||50000;document.getElementById('garbageCost').value=c.garbage||20000;}});}
function loadBankConfig(){database.ref('config/bank').once('value').then(s=>{if(s.exists()){bankConfig=s.val();}});}
function loadOccupiedRooms(){database.ref('rooms').orderByChild('status').equalTo('occupied').once('value').then(s=>{const sel=document.getElementById('roomSelect');sel.innerHTML='<option value="">-- Ch·ªçn ph√≤ng --</option>';if(s.exists()){s.forEach(cs=>{const r=cs.val();const opt=document.createElement('option');opt.value=cs.key;opt.textContent=`Ph√≤ng ${r.number}`;sel.appendChild(opt);});}else{const opt=document.createElement('option');opt.textContent='Kh√¥ng c√≥ ph√≤ng ƒë√£ thu√™';sel.appendChild(opt);}});}

document.getElementById('roomSelect').addEventListener('change',function(){const roomId=this.value;if(!roomId){document.getElementById('bookingInfo').style.display='none';return;}database.ref('bookings').orderByChild('roomId').equalTo(roomId).once('value').then(s=>{if(s.exists()){s.forEach(cs=>{currentBooking={id:cs.key,...cs.val()};document.getElementById('customerName').value=currentBooking.customerName;document.getElementById('idNumber').value=currentBooking.idNumber;document.getElementById('initialElectricity').value=currentBooking.initialElectricity;document.getElementById('initialWater').value=currentBooking.initialWater;document.getElementById('bookingInfo').style.display='block';calculateCost();});}else{alert('Kh√¥ng t√¨m th·∫•y th√¥ng tin ƒë·∫∑t ph√≤ng');}});});

function calculateCost(){if(!currentBooking)return;const finalElectricity=parseInt(document.getElementById('finalElectricity').value)||0;const finalWater=parseInt(document.getElementById('finalWater').value)||0;const electricityPrice=parseInt(document.getElementById('electricityPrice').value)||0;const waterPrice=parseInt(document.getElementById('waterPrice').value)||0;const wifiCost=parseInt(document.getElementById('wifiCost').value)||0;const garbageCost=parseInt(document.getElementById('garbageCost').value)||0;const otherCost=parseInt(document.getElementById('otherCost').value)||0;const electricityUsed=finalElectricity-currentBooking.initialElectricity;const waterUsed=finalWater-currentBooking.initialWater;const electricityCost=electricityUsed*electricityPrice;const waterCost=waterUsed*waterPrice;const roomCost=currentBooking.roomPrice;currentTotalCost=electricityCost+waterCost+roomCost+wifiCost+garbageCost+otherCost;document.getElementById('electricityCost').textContent=electricityCost.toLocaleString('vi-VN');document.getElementById('waterCost').textContent=waterCost.toLocaleString('vi-VN');document.getElementById('roomCost').textContent=roomCost.toLocaleString('vi-VN');document.getElementById('wifiCostDisplay').textContent=wifiCost.toLocaleString('vi-VN');document.getElementById('garbageCostDisplay').textContent=garbageCost.toLocaleString('vi-VN');document.getElementById('otherCostDisplay').textContent=otherCost.toLocaleString('vi-VN');document.getElementById('totalCost').textContent=currentTotalCost.toLocaleString('vi-VN');}

['finalElectricity','finalWater','electricityPrice','waterPrice','wifiCost','garbageCost','otherCost'].forEach(id=>{document.getElementById(id).addEventListener('input',calculateCost);});

document.getElementById('generateQRBtn').addEventListener('click',function(){if(currentTotalCost<=0){alert('Vui l√≤ng nh·∫≠p th√¥ng tin ƒë·ªÉ t√≠nh to√°n tr∆∞·ªõc khi t·∫°o m√£ QR');return;}if(!bankConfig.bankName||!bankConfig.bankAccount){alert('Ch∆∞a c·∫•u h√¨nh ng√¢n h√†ng trong C√†i ƒë·∫∑t');return;}const qrSection=document.getElementById('qrSection');const qrCodeDiv=document.getElementById('qrCode');qrCodeDiv.innerHTML='';const today=new Date();const ngay=`${today.getDate()}/${today.getMonth()+1}/${today.getFullYear()}`;const content=`${bankConfig.bankContent||'Thanh to√°n ti·ªÅn th√°ng'} ${ngay}`;const qrUrl=`https://img.vietqr.io/image/${bankConfig.bankName}-${bankConfig.bankAccount}-compact2.png?amount=${currentTotalCost}&addInfo=${encodeURIComponent(content)}`;const img=document.createElement('img');img.src=qrUrl;img.style.maxWidth='200px';qrCodeDiv.appendChild(img);qrSection.style.display='block';});

document.getElementById('copyZaloBtn').addEventListener('click', function(){
  if(currentTotalCost <= 0){
    alert('Vui l√≤ng t√≠nh to√°n tr∆∞·ªõc khi chia s·∫ª');
    return;
  }
  if(!bankConfig.bankName || !bankConfig.bankAccount){
    alert('Ch∆∞a c·∫•u h√¨nh ng√¢n h√†ng trong C√†i ƒë·∫∑t');
    return;
  }

  const today = new Date();
  const ngay = `${today.getDate()}/${today.getMonth()+1}/${today.getFullYear()}`;
  const content = `${bankConfig.bankContent || 'Thanh to√°n ti·ªÅn th√°ng'} ${ngay}`;

  // ‚úÖ Th√™m accountName ƒë·ªÉ hi·ªán t√™n ch·ªß t√†i kho·∫£n
  const qrUrl = `https://img.vietqr.io/image/${bankConfig.bankName}-${bankConfig.bankAccount}-compact2.png?amount=${currentTotalCost}&addInfo=${encodeURIComponent(content)}&accountName=${encodeURIComponent(bankConfig.accountName || '')}`;

  const msg =
`K·∫æT QU·∫¢ T√çNH TO√ÅN
Ti·ªÅn ƒëi·ªán: ${document.getElementById('electricityCost').textContent} VNƒê
Ti·ªÅn n∆∞·ªõc: ${document.getElementById('waterCost').textContent} VNƒê
Ti·ªÅn ph√≤ng: ${document.getElementById('roomCost').textContent} VNƒê
Ti·ªÅn WiFi: ${document.getElementById('wifiCostDisplay').textContent} VNƒê
Ti·ªÅn r√°c: ${document.getElementById('garbageCostDisplay').textContent} VNƒê
Ti·ªÅn kh√°c: ${document.getElementById('otherCostDisplay').textContent} VNƒê
----------------------
T·ªîNG C·ªòNG: ${document.getElementById('totalCost').textContent} VNƒê

üí≥ Ng√¢n h√†ng: ${bankConfig.bankName}
üë§ Ch·ªß TK: ${bankConfig.accountName || '---'}
üî¢ S·ªë TK: ${bankConfig.bankAccount}

üëâ Qu√©t QR ho·∫∑c b·∫•m link ƒë·ªÉ thanh to√°n:
${qrUrl}`;

  navigator.clipboard.writeText(msg).then(() =>
    showNotification('ƒê√£ sao ch√©p! D√°n v√†o Zalo ƒë·ªÉ g·ª≠i.')
  );
});

document.getElementById('openZaloBtn').addEventListener('click',function(){const isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);if(isMobile){window.location.href='zalo://';setTimeout(()=>{window.location.href='https://zalo.me';},1000);}else{window.open('https://zalo.me','_blank');}});

function showNotification(msg,isError=false){const noti=document.getElementById('notification');noti.textContent=msg;if(isError){noti.classList.add('error');}else{noti.classList.remove('error');}noti.classList.add('show');setTimeout(()=>{noti.classList.remove('show');},3000);}

document.getElementById('checkoutBtn').addEventListener('click',()=>{if(!currentBooking)return;const finalElectricity=parseInt(document.getElementById('finalElectricity').value)||0;const finalWater=parseInt(document.getElementById('finalWater').value)||0;if(finalElectricity<currentBooking.initialElectricity){alert('Ch·ªâ s·ªë ƒëi·ªán kh√¥ng h·ª£p l·ªá');return;}if(finalWater<currentBooking.initialWater){alert('Ch·ªâ s·ªë n∆∞·ªõc kh√¥ng h·ª£p l·ªá');return;}const electricityUsed=finalElectricity-currentBooking.initialElectricity;const waterUsed=finalWater-currentBooking.initialWater;const electricityPrice=parseInt(document.getElementById('electricityPrice').value)||0;const waterPrice=parseInt(document.getElementById('waterPrice').value)||0;const wifiCost=parseInt(document.getElementById('wifiCost').value)||0;const garbageCost=parseInt(document.getElementById('garbageCost').value)||0;const otherCost=parseInt(document.getElementById('otherCost').value)||0;const otherDescription=document.getElementById('otherDescription').value;const roomCost=currentBooking.roomPrice;const totalCost=electricityUsed*electricityPrice+waterUsed*waterPrice+roomCost+wifiCost+garbageCost+otherCost;const checkoutData={roomId:currentBooking.roomId,bookingId:currentBooking.id,customerName:currentBooking.customerName,finalElectricity,finalWater,electricityUsed,waterUsed,electricityPrice,waterPrice,electricityCost:electricityUsed*electricityPrice,waterCost:waterUsed*waterPrice,roomCost,wifiCost,garbageCost,otherCost,otherDescription,totalCost,checkoutDate:new Date().toISOString(),notes:document.getElementById('checkoutNotes').value};database.ref('checkouts').push(checkoutData).then(()=>database.ref('rooms/'+currentBooking.roomId).update({status:'available'})).then(()=>database.ref('bookings/'+currentBooking.id).remove()).then(()=>{alert('Tr·∫£ ph√≤ng th√†nh c√¥ng!');window.location.reload();});});

document.getElementById('logoutBtn').addEventListener('click',()=>{auth.signOut().then(()=>{window.location.href='index.html';});});
</script>
</body>
</html>

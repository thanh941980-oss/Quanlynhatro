<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Trả phòng - Quản lý nhà trọ</title>
  <style>
    /* Giữ nguyên phần CSS như cũ */
    * {margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;}
    body {background-color:#f5f5f5;color:#333;line-height:1.6;font-size:14px;}
    /* ... (giữ nguyên toàn bộ CSS) ... */
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
<!-- Giữ nguyên phần HTML như cũ -->
<header>
  <h1>Quản lý nhà trọ - Trả phòng</h1>
  <div>
    <button onclick="window.location.href='dashboard.html'" class="btn back-btn">Quay lại</button>
    <button id="logoutBtn" class="btn logout-btn">Đăng xuất</button>
  </div>
</header>

<div class="container">
  <h2>Thông tin trả phòng</h2>
  <div class="form-container">
    <div class="form-group">
      <label for="roomSelect">Chọn phòng</label>
      <select id="roomSelect"><option value="">-- Chọn phòng --</option></select>
    </div>

    <div id="bookingInfo" style="display:none;">
      <!-- Giữ nguyên phần HTML như cũ -->
    </div>
  </div>
</div>

<div class="notification" id="notification">Nội dung đã được sao chép!</div>

<script>
const firebaseConfig={apiKey:"AIzaSyAz38ll5L6nZOicZyQRFtKd0TuzohrLFws",authDomain:"quan-ly-nha-tro-2a4bf.firebaseapp.com",databaseURL:"https://quan-ly-nha-tro-2a4bf-default-rtdb.asia-southeast1.firebasedatabase.app",projectId:"quan-ly-nha-tro-2a4bf",storageBucket:"quan-ly-nha-tro-2a4bf.firebasestorage.app",messagingSenderId:"490747665921",appId:"1:490747665921:web:48b0e2bad3a0f894c22a00"};
firebase.initializeApp(firebaseConfig);const auth=firebase.auth();const database=firebase.database();

let currentUser = null;
let currentBooking=null;let currentTotalCost=0;let bankConfig={};
let priceConfig = {}; // Lưu trữ cấu hình giá

auth.onAuthStateChanged(user=>{
  if(!user){
    window.location.href='index.html';
  }else{
    currentUser = user;
    loadPriceConfig();
    loadBankConfig();
    loadOccupiedRooms();
    loadLicenseStatus();
  }
});

// Hàm load cấu hình giá - ĐÃ CẢI THIỆN
function loadPriceConfig(){
  database.ref(`users/${currentUser.uid}/config/prices`).once('value').then(snapshot=>{
    if(snapshot.exists()){
      priceConfig = snapshot.val();
      
      // Đặt giá trị mặc định nếu không có trong database
      document.getElementById('electricityPrice').value = priceConfig.electricity || 3500;
      document.getElementById('waterPrice').value = priceConfig.water || 20000;
      document.getElementById('wifiCost').value = priceConfig.wifi || 50000;
      document.getElementById('garbageCost').value = priceConfig.garbage || 20000;
      
      console.log('Đã load cấu hình giá:', priceConfig);
    } else {
      // Nếu không có cấu hình, sử dụng giá mặc định
      priceConfig = {
        electricity: 3500,
        water: 20000,
        wifi: 50000,
        garbage: 20000
      };
      
      document.getElementById('electricityPrice').value = priceConfig.electricity;
      document.getElementById('waterPrice').value = priceConfig.water;
      document.getElementById('wifiCost').value = priceConfig.wifi;
      document.getElementById('garbageCost').value = priceConfig.garbage;
      
      console.log('Sử dụng giá mặc định:', priceConfig);
    }
    
    // Tính toán lại chi phí nếu có booking hiện tại
    if(currentBooking){
      calculateCost();
    }
  }).catch(error => {
    console.error('Lỗi khi load cấu hình giá:', error);
    // Sử dụng giá mặc định nếu có lỗi
    document.getElementById('electricityPrice').value = 3500;
    document.getElementById('waterPrice').value = 20000;
    document.getElementById('wifiCost').value = 50000;
    document.getElementById('garbageCost').value = 20000;
  });
}

function loadBankConfig(){
  database.ref(`users/${currentUser.uid}/config/bank`).once('value').then(snapshot=>{
    if(snapshot.exists()){
      bankConfig = snapshot.val();
      console.log('Đã load cấu hình ngân hàng:', bankConfig);
    } else {
      console.log('Chưa có cấu hình ngân hàng');
    }
  }).catch(error => {
    console.error('Lỗi khi load cấu hình ngân hàng:', error);
  });
}

function loadOccupiedRooms(){
  database.ref(`users/${currentUser.uid}/rooms`).once('value').then(snapshot=>{
    const select = document.getElementById('roomSelect');
    select.innerHTML = '<option value="">-- Chọn phòng --</option>';
    
    console.log('Dữ liệu phòng:', snapshot.val());
    
    if(snapshot.exists()){
      let hasOccupiedRooms = false;
      
      snapshot.forEach(roomSnapshot=>{
        const room = roomSnapshot.val();
        const roomNumber = roomSnapshot.key;
        
        console.log('Kiểm tra phòng:', roomNumber, room);
        
        if(room.status === 'occupied'){
          hasOccupiedRooms = true;
          const option = document.createElement('option');
          option.value = roomNumber;
          option.textContent = `Phòng ${roomNumber}`;
          select.appendChild(option);
        }
      });
      
      if(!hasOccupiedRooms){
        const option = document.createElement('option');
        option.textContent = 'Không có phòng đã thuê';
        option.disabled = true;
        select.appendChild(option);
      }
    } else {
      const option = document.createElement('option');
      option.textContent = 'Không có phòng đã thuê';
      option.disabled = true;
      select.appendChild(option);
    }
  }).catch(error => {
    console.error('Lỗi khi load phòng:', error);
  });
}

// Các hàm còn lại giữ nguyên với một số cải tiến nhỏ
document.getElementById('roomSelect').addEventListener('change',function(){
  const roomId = this.value;
  if(!roomId){
    document.getElementById('bookingInfo').style.display = 'none';
    currentBooking = null;
    return;
  }
  
  database.ref(`users/${currentUser.uid}/bookings`).orderByChild('roomId').equalTo(roomId).once('value').then(snapshot=>{
    if(snapshot.exists()){
      snapshot.forEach(bookingSnapshot=>{
        currentBooking = {
          id: bookingSnapshot.key,
          ...bookingSnapshot.val()
        };
        
        document.getElementById('customerName').value = currentBooking.customerName;
        document.getElementById('idNumber').value = currentBooking.idNumber;
        document.getElementById('initialElectricity').value = currentBooking.initialElectricity;
        document.getElementById('initialWater').value = currentBooking.initialWater;
        document.getElementById('bookingInfo').style.display = 'block';
        
        // Tính toán chi phí ngay khi load thông tin phòng
        calculateCost();
      });
    } else {
      alert('Không tìm thấy thông tin đặt phòng cho phòng này');
      document.getElementById('bookingInfo').style.display = 'none';
    }
  }).catch(error => {
    console.error('Lỗi khi load thông tin đặt phòng:', error);
    alert('Có lỗi xảy ra khi tải thông tin đặt phòng');
  });
});

function calculateCost(){
  if(!currentBooking) return;
  
  const finalElectricity = parseInt(document.getElementById('finalElectricity').value) || 0;
  const finalWater = parseInt(document.getElementById('finalWater').value) || 0;
  const electricityPrice = parseInt(document.getElementById('electricityPrice').value) || 0;
  const waterPrice = parseInt(document.getElementById('waterPrice').value) || 0;
  const wifiCost = parseInt(document.getElementById('wifiCost').value) || 0;
  const garbageCost = parseInt(document.getElementById('garbageCost').value) || 0;
  const otherCost = parseInt(document.getElementById('otherCost').value) || 0;
  
  // Validate chỉ số
  if(finalElectricity < currentBooking.initialElectricity){
    document.getElementById('electricityCost').textContent = 'Chỉ số không hợp lệ';
    return;
  }
  
  if(finalWater < currentBooking.initialWater){
    document.getElementById('waterCost').textContent = 'Chỉ số không hợp lệ';
    return;
  }
  
  const electricityUsed = finalElectricity - currentBooking.initialElectricity;
  const waterUsed = finalWater - currentBooking.initialWater;
  const electricityCost = electricityUsed * electricityPrice;
  const waterCost = waterUsed * waterPrice;
  const roomCost = currentBooking.roomPrice;
  
  currentTotalCost = electricityCost + waterCost + roomCost + wifiCost + garbageCost + otherCost;
  
  document.getElementById('electricityCost').textContent = electricityCost.toLocaleString('vi-VN');
  document.getElementById('waterCost').textContent = waterCost.toLocaleString('vi-VN');
  document.getElementById('roomCost').textContent = roomCost.toLocaleString('vi-VN');
  document.getElementById('wifiCostDisplay').textContent = wifiCost.toLocaleString('vi-VN');
  document.getElementById('garbageCostDisplay').textContent = garbageCost.toLocaleString('vi-VN');
  document.getElementById('otherCostDisplay').textContent = otherCost.toLocaleString('vi-VN');
  document.getElementById('totalCost').textContent = currentTotalCost.toLocaleString('vi-VN');
}

// Các sự kiện input để tính toán tự động
['finalElectricity','finalWater','electricityPrice','waterPrice','wifiCost','garbageCost','otherCost'].forEach(id=>{
  document.getElementById(id).addEventListener('input', calculateCost);
});

// Các hàm còn lại giữ nguyên
document.getElementById('generateQRBtn').addEventListener('click',function(){
  if(currentTotalCost <= 0){
    alert('Vui lòng nhập thông tin để tính toán trước khi tạo mã QR');
    return;
  }
  if(!bankConfig.bankName || !bankConfig.bankAccount){
    alert('Chưa cấu hình ngân hàng trong Cài đặt');
    return;
  }
  
  const qrSection = document.getElementById('qrSection');
  const qrCodeDiv = document.getElementById('qrCode');
  qrCodeDiv.innerHTML = '';
  
  const today = new Date();
  const ngay = `${today.getDate()}/${today.getMonth()+1}/${today.getFullYear()}`;
  const content = `${bankConfig.bankContent || 'Thanh toán tiền tháng'} ${ngay}`;
  
  const qrUrl = `https://img.vietqr.io/image/${bankConfig.bankName}-${bankConfig.bankAccount}-compact2.png?amount=${currentTotalCost}&addInfo=${encodeURIComponent(content)}`;
  
  const img = document.createElement('img');
  img.src = qrUrl;
  img.style.maxWidth = '200px';
  qrCodeDiv.appendChild(img);
  qrSection.style.display = 'block';
});

document.getElementById('copyZaloBtn').addEventListener('click', function(){
  if(currentTotalCost <= 0){
    alert('Vui lòng tính toán trước khi chia sẻ');
    return;
  }
  if(!bankConfig.bankName || !bankConfig.bankAccount){
    alert('Chưa cấu hình ngân hàng trong Cài đặt');
    return;
  }

  const today = new Date();
  const thang = today.getMonth() + 1;
  const nam = today.getFullYear();
  const ngay = `${today.getDate()}/${thang}/${nam}`;
  
  const content = `${bankConfig.bankContent || 'Thanh toán tiền tháng'} ${thang}/${nam}`;
  const qrUrl = `https://img.vietqr.io/image/${bankConfig.bankName}-${bankConfig.bankAccount}-compact2.png?amount=${currentTotalCost}&addInfo=${encodeURIComponent(content)}`;

  const msg =
`💳 *THANH TOÁN TIỀN PHÒNG THÁNG ${thang}/${nam}*

🏠 Phòng: ${currentBooking.roomId}
👤 Khách hàng: ${currentBooking.customerName}
📅 Ngày tính: ${ngay}

📊 *CHI TIẾT THANH TOÁN:*
• Tiền điện: ${document.getElementById('electricityCost').textContent} VNĐ
• Tiền nước: ${document.getElementById('waterCost').textContent} VNĐ  
• Tiền phòng: ${document.getElementById('roomCost').textContent} VNĐ
• Tiền WiFi: ${document.getElementById('wifiCostDisplay').textContent} VNĐ
• Tiền rác: ${document.getElementById('garbageCostDisplay').textContent} VNĐ
• Tiền khác: ${document.getElementById('otherCostDisplay').textContent} VNĐ
─────────────────
💰 *TỔNG CỘNG: ${document.getElementById('totalCost').textContent} VNĐ*

🏦 *THÔNG TIN CHUYỂN KHOẢN:*
• Ngân hàng: ${bankConfig.bankName}
• Chủ TK: ${bankConfig.accountName || '---'}
• Số TK: ${bankConfig.bankAccount}
• Nội dung: ${content}

📱 *HƯỚNG DẪN THANH TOÁN:*
1. Chuyển khoản theo thông tin trên
2. Hoặc quét mã QR bên dưới
3. Gửi biên lai cho chủ trọ sau khi thanh toán

🔗 *MÃ QR THANH TOÁN:*
${qrUrl}

_Cảm ơn bạn!_`;

  navigator.clipboard.writeText(msg).then(() => {
    showNotification('Đã sao chép nội dung thanh toán! Dán vào Zalo để gửi cho khách hàng.');
  }).catch(err => {
    console.error('Lỗi sao chép: ', err);
    showNotification('Lỗi sao chép!', true);
  });
});

document.getElementById('openZaloBtn').addEventListener('click',function(){
  const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  if(isMobile){
    window.location.href = 'zalo://';
    setTimeout(() => { window.location.href = 'https://zalo.me'; }, 1000);
  } else {
    window.open('https://zalo.me', '_blank');
  }
});

function showNotification(msg, isError = false){
  const noti = document.getElementById('notification');
  noti.textContent = msg;
  if(isError){
    noti.classList.add('error');
  } else {
    noti.classList.remove('error');
  }
  noti.classList.add('show');
  setTimeout(() => {
    noti.classList.remove('show');
  }, 3000);
}

document.getElementById('checkoutBtn').addEventListener('click', () => {
  if(!currentBooking) return;
  
  const finalElectricity = parseInt(document.getElementById('finalElectricity').value) || 0;
  const finalWater = parseInt(document.getElementById('finalWater').value) || 0;
  
  if(finalElectricity < currentBooking.initialElectricity){
    alert('Chỉ số điện không hợp lệ');
    return;
  }
  if(finalWater < currentBooking.initialWater){
    alert('Chỉ số nước không hợp lệ');
    return;
  }
  
  const electricityUsed = finalElectricity - currentBooking.initialElectricity;
  const waterUsed = finalWater - currentBooking.initialWater;
  const electricityPrice = parseInt(document.getElementById('electricityPrice').value) || 0;
  const waterPrice = parseInt(document.getElementById('waterPrice').value) || 0;
  const wifiCost = parseInt(document.getElementById('wifiCost').value) || 0;
  const garbageCost = parseInt(document.getElementById('garbageCost').value) || 0;
  const otherCost = parseInt(document.getElementById('otherCost').value) || 0;
  const otherDescription = document.getElementById('otherDescription').value;
  const roomCost = currentBooking.roomPrice;
  
  const totalCost = electricityUsed * electricityPrice + waterUsed * waterPrice + roomCost + wifiCost + garbageCost + otherCost;
  
  const checkoutData = {
    roomId: currentBooking.roomId,
    bookingId: currentBooking.id,
    customerName: currentBooking.customerName,
    finalElectricity,
    finalWater,
    electricityUsed,
    waterUsed,
    electricityPrice,
    waterPrice,
    electricityCost: electricityUsed * electricityPrice,
    waterCost: waterUsed * waterPrice,
    roomCost,
    wifiCost,
    garbageCost,
    otherCost,
    otherDescription,
    totalCost,
    checkoutDate: new Date().toISOString(),
    notes: document.getElementById('checkoutNotes').value
  };
  
  database.ref(`users/${currentUser.uid}/checkouts`).push(checkoutData)
    .then(() => database.ref(`users/${currentUser.uid}/rooms/${currentBooking.roomId}`).update({status: 'available'}))
    .then(() => database.ref(`users/${currentUser.uid}/bookings/${currentBooking.id}`).remove())
    .then(() => {
      alert('Trả phòng thành công!');
      window.location.reload();
    })
    .catch(error => {
      console.error('Error during checkout:', error);
      alert('Có lỗi xảy ra khi trả phòng');
    });
});

document.getElementById('logoutBtn').addEventListener('click', () => {
  auth.signOut().then(() => {
    window.location.href = 'index.html';
  });
});

function loadLicenseStatus(){
  database.ref(`users/${currentUser.uid}/license`).on('value', snapshot => {
    if(snapshot.exists() && snapshot.val().licensed){
      document.getElementById('licenseStatus').textContent = 'Đã cấp bản quyền';
    } else {
      document.getElementById('licenseStatus').textContent = 'Miễn phí';
    }
  });
}
</script>

<footer style="text-align:center; padding:10px; font-size:0.9rem;">
  © <span id="copyrightYear"></span> Quản lý nhà trọ — Bản quyền <strong id="licenseStatus">Miễn phí</strong>
  <div style="font-size:0.75rem; margin-top:4px; color:#666;">
    Nếu đã kích hoạt bản quyền, hệ thống sẽ lưu không giới hạn số phòng.
  </div>
</footer>
<script>
  document.getElementById('copyrightYear').textContent = new Date().getFullYear();
</script>

</body>
</html>

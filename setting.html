<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cài đặt - Quản lý nhà trọ</title>
  <style>
    * {margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;}
    body {background:#f5f5f5;color:#333;line-height:1.6;}
    header {background:#2c3e50;color:#fff;padding:1rem;display:flex;justify-content:space-between;align-items:center;}
    .container {max-width:800px;margin:0 auto;padding:20px;}
    .form-container {background:#fff;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,.1);padding:20px;margin-top:20px;}
    .form-group {margin-bottom:1.5rem;}
    .form-group label {display:block;margin-bottom:.5rem;font-weight:500;}
    .form-group input,.form-group select {width:100%;padding:.75rem;border:1px solid #ddd;border-radius:4px;font-size:1rem;}
    .btn {display:inline-block;padding:.75rem 1.5rem;background:#3498db;color:#fff;border:none;border-radius:4px;font-size:1rem;cursor:pointer;transition:.3s;}
    .btn:hover {background:#2980b9;}
    .back-btn{background:#7f8c8d}.back-btn:hover{background:#95a5a6}
    .logout-btn{background:#e74c3c}.logout-btn:hover{background:#c0392b}
    .tab-container{margin-bottom:20px;}
    .tab-buttons{display:flex;border-bottom:1px solid #ddd;flex-wrap:wrap;}
    .tab-btn{padding:10px 20px;background:none;border:none;cursor:pointer;font-size:1rem;font-weight:500;color:#7f8c8d;border-bottom:3px solid transparent;}
    .tab-btn.active{color:#3498db;border-bottom:3px solid #3498db;}
    .tab-content{display:none;padding:20px 0;}
    .tab-content.active{display:block;}
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
<header>
  <h1>Quản lý nhà trọ - Cài đặt</h1>
  <div>
    <button onclick="window.location.href='dashboard.html'" class="btn back-btn">Quay lại</button>
    <button id="logoutBtn" class="btn logout-btn">Đăng xuất</button>
  </div>
</header>

<div class="container">
  <h2>Cài đặt hệ thống</h2>
  <div class="tab-container">
    <div class="tab-buttons">
      <button class="tab-btn active" data-tab="room-management">Quản lý phòng</button>
      <button class="tab-btn" data-tab="price-config">Cấu hình giá</button>
      <button class="tab-btn" data-tab="bank-config">Ngân hàng</button>
      <button class="tab-btn" data-tab="user-settings">Tài khoản</button>
    </div>

    <div class="form-container">
      <!-- Quản lý phòng -->
      <div class="tab-content active" id="room-management">
        <h3>Thêm phòng mới</h3>
        <div class="form-group"><label for="roomNumber">Số phòng</label><input type="text" id="roomNumber"></div>
        <div class="form-group"><label for="roomPrice">Giá phòng (VNĐ/tháng)</label><input type="number" id="roomPrice"></div>
        <div class="form-group"><label for="roomArea">Diện tích (m²)</label><input type="number" id="roomArea"></div>
        <button id="addRoomBtn" class="btn">Thêm phòng</button>
        <h3 style="margin-top:30px;">Danh sách phòng</h3>
        <div id="roomList"></div>
      </div>

      <!-- Cấu hình giá -->
      <div class="tab-content" id="price-config">
        <h3>Cấu hình giá mặc định</h3>
        <div class="form-group"><label for="defaultElectricityPrice">Giá điện</label><input type="number" id="defaultElectricityPrice"></div>
        <div class="form-group"><label for="defaultWaterPrice">Giá nước</label><input type="number" id="defaultWaterPrice"></div>
        <div class="form-group"><label for="defaultWifiPrice">Giá WiFi</label><input type="number" id="defaultWifiPrice"></div>
        <div class="form-group"><label for="defaultGarbagePrice">Giá rác</label><input type="number" id="defaultGarbagePrice"></div>
        <button id="savePriceConfigBtn" class="btn">Lưu cấu hình</button>
      </div>

      <!-- Cấu hình ngân hàng -->
      <div class="tab-content" id="bank-config">
        <h3>Cấu hình ngân hàng</h3>
        <div class="form-group">
          <label for="bankName">Ngân hàng</label>
          <select id="bankName">
            <option value="VCB">Vietcombank</option>
            <option value="TCB">Techcombank</option>
            <option value="MB">MB Bank</option>
            <option value="ACB">ACB</option>
            <option value="BIDV">BIDV</option>
            <option value="AGRIBANK">Agribank</option>
          </select>
        </div>
        <div class="form-group"><label for="bankAccount">Số tài khoản</label><input type="text" id="bankAccount"></div>
        <div class="form-group"><label for="accountName">Tên chủ tài khoản</label><input type="text" id="accountName"></div>
        <div class="form-group"><label for="bankContent">Nội dung mặc định</label><input type="text" id="bankContent" value="Thanh toán tiền tháng"></div>
        <button id="saveBankConfigBtn" class="btn">Lưu thông tin ngân hàng</button>
      </div>

      <!-- Tài khoản -->
      <div class="tab-content" id="user-settings">
        <h3>Thông tin tài khoản</h3>
        <div class="form-group"><label for="userEmail">Email</label><input type="email" id="userEmail" disabled></div>
        <div class="form-group"><label for="userPassword">Mật khẩu mới</label><input type="password" id="userPassword"></div>
        <div class="form-group"><label for="userConfirmPassword">Xác nhận mật khẩu</label><input type="password" id="userConfirmPassword"></div>
        <button id="saveUserSettingsBtn" class="btn">Lưu thay đổi</button>
      </div>
    </div>
  </div>
</div>

<script>
const firebaseConfig={apiKey:"AIzaSyAz38ll5L6nZOicZyQRFtKd0TuzohrLFws",authDomain:"quan-ly-nha-tro-2a4bf.firebaseapp.com",databaseURL:"https://quan-ly-nha-tro-2a4bf-default-rtdb.asia-southeast1.firebasedatabase.app",projectId:"quan-ly-nha-tro-2a4bf",storageBucket:"quan-ly-nha-tro-2a4bf.firebasestorage.app",messagingSenderId:"490747665921",appId:"1:490747665921:web:48b0e2bad3a0f894c22a00"};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();const database=firebase.database();

auth.onAuthStateChanged(user=>{
  if(!user){window.location.href='index.html';}
  else{
    document.getElementById('userEmail').value=user.email;
    loadBankConfig();
    loadRooms(); // THÊM DÒNG NÀY
    loadPriceConfig(); // THÊM DÒNG NÀY
  }
});

// Tab switch
document.querySelectorAll('.tab-btn').forEach(btn=>
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tab-content').forEach(tab=>tab.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.getElementById(btn.dataset.tab).classList.add('active');
    btn.classList.add('active');
  })
);

// Save bank config
document.getElementById('saveBankConfigBtn').addEventListener('click',()=>{
  const bankName=document.getElementById('bankName').value;
  const bankAccount=document.getElementById('bankAccount').value;
  const accountName=document.getElementById('accountName').value;
  const bankContent=document.getElementById('bankContent').value;

  if(!bankName||!bankAccount){
    alert("Vui lòng nhập đầy đủ");
    return;
  }

  database.ref('config/bank').set({
    bankName,
    bankAccount,
    accountName,
    bankContent
  }).then(()=>alert("Lưu thành công"));
});

// Load bank config
function loadBankConfig(){
  database.ref('config/bank').once('value').then(snap=>{
    if(snap.exists()){
      const d=snap.val();
      document.getElementById('bankName').value=d.bankName;
      document.getElementById('bankAccount').value=d.bankAccount;
      document.getElementById('accountName').value=d.accountName || '';
      document.getElementById('bankContent').value=d.bankContent;
    }
  });
}
/////////////////////////////////////////////////////////
// Tải danh sách phòng
        function loadRooms() {
            database.ref('rooms').once('value')
                .then((snapshot) => {
                    const roomList = document.getElementById('roomList');
                    roomList.innerHTML = '';
                    
                    if (snapshot.exists()) {
                        const table = document.createElement('table');
                        table.innerHTML = `
                            <thead>
                                <tr>
                                    <th>Số phòng</th>
                                    <th>Giá phòng</th>
                                    <th>Diện tích</th>
                                    <th>Trạng thái</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        `;
                        
                        const tbody = table.querySelector('tbody');
                        
                        snapshot.forEach((childSnapshot) => {
                            const room = childSnapshot.val();
                            const row = document.createElement('tr');
                            
                            row.innerHTML = `
                                <td>${room.number}</td>
                                <td>${room.price.toLocaleString('vi-VN')} VNĐ</td>
                                <td>${room.area} m²</td>
                                <td>${room.status === 'available' ? 'Trống' : 'Đã thuê'}</td>
                                <td>
                                    <button class="btn small-btn edit-room-btn" data-id="${childSnapshot.key}">Sửa</button>
                                    <button class="btn small-btn delete-room-btn" data-id="${childSnapshot.key}">Xóa</button>
                                </td>
                            `;
                            
                            tbody.appendChild(row);
                        });
                        
                        roomList.appendChild(table);
                        
                        // Gắn sự kiện cho nút sửa và xóa
                        document.querySelectorAll('.edit-room-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const roomId = e.target.getAttribute('data-id');
                                editRoom(roomId);
                            });
                        });
                        
                        document.querySelectorAll('.delete-room-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const roomId = e.target.getAttribute('data-id');
                                deleteRoom(roomId);
                            });
                        });
                    } else {
                        roomList.innerHTML = '<p>Chưa có phòng nào.</p>';
                    }
                })
                .catch((error) => {
                    console.error('Lỗi khi tải danh sách phòng:', error);
                });
        }
        
        // Tải cấu hình giá
        function loadPriceConfig() {
            database.ref('config/prices').once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        const config = snapshot.val();
                        document.getElementById('defaultElectricityPrice').value = config.electricity || 3500;
                        document.getElementById('defaultWaterPrice').value = config.water || 20000;
                        document.getElementById('defaultWifiPrice').value = config.wifi || 50000;
                        document.getElementById('defaultGarbagePrice').value = config.garbage || 20000;
                    }
                })
                .catch((error) => {
                    console.error('Lỗi khi tải cấu hình giá:', error);
                });
        }
        
        // Thêm phòng mới
        document.getElementById('addRoomBtn').addEventListener('click', () => {
            const roomNumber = document.getElementById('roomNumber').value;
            const roomPrice = document.getElementById('roomPrice').value;
            const roomArea = document.getElementById('roomArea').value;
            
            if (!roomNumber || !roomPrice || !roomArea) {
                alert('Vui lòng điền đầy đủ thông tin!');
                return;
            }
            
            const roomData = {
                number: roomNumber,
                price: parseInt(roomPrice),
                area: parseInt(roomArea),
                status: 'available',
                createdAt: new Date().toISOString()
            };
            
            database.ref('rooms').push(roomData)
                .then(() => {
                    alert('Thêm phòng thành công!');
                    document.getElementById('roomNumber').value = '';
                    document.getElementById('roomPrice').value = '';
                    document.getElementById('roomArea').value = '';
                    loadRooms();
                })
                .catch((error) => {
                    console.error('Lỗi khi thêm phòng:', error);
                    alert('Có lỗi xảy ra khi thêm phòng.');
                });
        });
        
        // Sửa thông tin phòng
        function editRoom(roomId) {
            database.ref('rooms/' + roomId).once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        const room = snapshot.val();
                        const newNumber = prompt('Nhập số phòng mới:', room.number);
                        if (!newNumber) return;
                        
                        const newPrice = prompt('Nhập giá phòng mới:', room.price);
                        if (!newPrice) return;
                        
                        const newArea = prompt('Nhập diện tích mới:', room.area);
                        if (!newArea) return;
                        
                        database.ref('rooms/' + roomId).update({
                            number: newNumber,
                            price: parseInt(newPrice),
                            area: parseInt(newArea)
                        })
                        .then(() => {
                            alert('Cập nhật phòng thành công!');
                            loadRooms();
                        })
                        .catch((error) => {
                            console.error('Lỗi khi cập nhật phòng:', error);
                            alert('Có lỗi xảy ra khi cập nhật phòng.');
                        });
                    }
                })
                .catch((error) => {
                    console.error('Lỗi khi tải thông tin phòng:', error);
                });
        }
        
        // Xóa phòng
        function deleteRoom(roomId) {
            if (confirm('Bạn có chắc chắn muốn xóa phòng này?')) {
                database.ref('rooms/' + roomId).remove()
                    .then(() => {
                        alert('Xóa phòng thành công!');
                        loadRooms();
                    })
                    .catch((error) => {
                        console.error('Lỗi khi xóa phòng:', error);
                        alert('Có lỗi xảy ra khi xóa phòng.');
                    });
            }
        }
        
        // Lưu cấu hình giá
        document.getElementById('savePriceConfigBtn').addEventListener('click', () => {
            const electricityPrice = document.getElementById('defaultElectricityPrice').value;
            const waterPrice = document.getElementById('defaultWaterPrice').value;
            const wifiPrice = document.getElementById('defaultWifiPrice').value;
            const garbagePrice = document.getElementById('defaultGarbagePrice').value;
            
            if (!electricityPrice || !waterPrice || !wifiPrice || !garbagePrice) {
                alert('Vui lòng điền đầy đủ thông tin!');
                return;
            }
            
            database.ref('config/prices').set({
                electricity: parseInt(electricityPrice),
                water: parseInt(waterPrice),
                wifi: parseInt(wifiPrice),
                garbage: parseInt(garbagePrice)
            })
            .then(() => {
                alert('Lưu cấu hình giá thành công!');
            })
            .catch((error) => {
                console.error('Lỗi khi lưu cấu hình giá:', error);
                alert('Có lỗi xảy ra khi lưu cấu hình giá.');
            });
        });
        
        // Lưu cài đặt người dùng
        document.getElementById('saveUserSettingsBtn').addEventListener('click', () => {
            const password = document.getElementById('userPassword').value;
            const confirmPassword = document.getElementById('userConfirmPassword').value;
            
            if (password && password !== confirmPassword) {
                alert('Mật khẩu xác nhận không khớp!');
                return;
            }
            
            const user = auth.currentUser;
            
            if (password) {
                user.updatePassword(password)
                    .then(() => {
                        alert('Cập nhật mật khẩu thành công!');
                        document.getElementById('userPassword').value = '';
                        document.getElementById('userConfirmPassword').value = '';
                    })
                    .catch((error) => {
                        console.error('Lỗi khi cập nhật mật khẩu:', error);
                        alert('Có lỗi xảy ra khi cập nhật mật khẩu.');
                    });
            } else {
                alert('Không có thay đổi nào để lưu.');
            }
        });
/////////////////////////////////////////////////////////
  // Gắn sự kiện cho các nút
document.getElementById("addRoomBtn").addEventListener("click", addRoom);
document.getElementById("savePriceConfigBtn").addEventListener("click", savePriceConfig);
document.getElementById("saveUserSettingsBtn").addEventListener("click", saveUserSettings);
// Logout
document.getElementById('logoutBtn').addEventListener('click',()=>{
  auth.signOut().then(()=>{window.location.href='index.html';});
});
</script>
</body>
</html>
